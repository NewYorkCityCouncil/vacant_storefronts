---
output:
  html_document:
    theme: cosmo
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.align="left", fig.width=14, fig.height=8)
```

```{r include=FALSE}
library(dplyr)
library(janitor)
library(ggplot2)
library(ggthemes)
library(stringr)
library(zoo)
library(data.table)
library(sf)
library(tidyr)
library(leaflet)
library(tibble)
library(htmltools)
library(leaflet.extras)

# Census tract shape file
# ct.shp <- st_read("/Users/nycc/Downloads/2010\ Census\ Tracts/geo_export_da780961-2ca4-4fe7-9532-f4d844c8e8a2.shp")
# ct.shp <- st_transform(ct.shp,'+proj=longlat +datum=WGS84')

# boro boundaries
boro <- read_sf("https://data.cityofnewyork.us/api/geospatial/tqmj-j8zm?method=export&format=GeoJSON") %>% 
  ungroup() %>%
  st_transform("+proj=longlat +datum=WGS84") %>% 
  st_simplify(dTolerance = .00001)
```

```{r}
leased_not_leased_2022 <- read.csv("https://data.cityofnewyork.us/resource/92iy-9c3n.csv?$limit=999999999") %>% clean_names()
```

```{r}
ct_vacant_dataset <- leased_not_leased_2022 %>%
  filter(reporting_year == '2021 and 2022') %>%
  mutate(boro_ct201 = substr(bbl, 1, 2), 
         census_tract_2 =  as.numeric(census_tract)*100, 
         census_tract_2 = str_pad(census_tract_2, width=6, pad="0"), 
         boro_ct201 = paste0(boro_ct201, census_tract_2))
```

```{r}
ct.shp <- read_sf("https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Census_Tracts_for_2020_US_Census/FeatureServer/0/query?where=1=1&outFields=*&outSR=4326&f=pgeojson")

# why are we rounding census tracts? because the vacant lot doesn't give modern census tract numbers???? genuinely makes NO sense.
# at least combine the shapes so you're not "double counting"
ct.shp = ct.shp %>%
  mutate(CTLabel_round = round(as.numeric(CTLabel), digits = 0), 
         CTLabel_round = as.numeric(CTLabel_round)*100, 
         CTLabel_round = str_pad(CTLabel_round, width=6, pad="0"),
         boro_ct201 = paste0(BoroCode,CTLabel_round)) %>%
  mutate(boro_ct201 = as.character(boro_ct201)) %>%
  group_by(boro_ct201) %>% 
  summarize(geometry = st_union(geometry))
```


```{r}

# aggregate the vacancy data by modified census tract and combine with spatial data
ct_vacant <- ct_vacant_dataset %>% 
  group_by(boro_ct201, vacant_on_12_31) %>% 
  summarize(count_vacant = n()) %>% 
  complete(vacant_on_12_31, fill = list(count_vacant = 0)) %>% 
  mutate(perc_vacant = count_vacant/sum(count_vacant), 
         perc_vacant = round(perc_vacant, 2)) %>% 
  ungroup() %>%
  as.data.frame() %>%
  left_join(ct.shp, by = c("boro_ct201"))

# prep spatial data for plotting
ct_vacant.shp <- ct_vacant %>% 
  filter(vacant_on_12_31=="YES") %>% 
  ungroup() %>% 
  st_as_sf() %>% 
  st_transform('+proj=longlat +datum=WGS84')

# ???
ct_vacant_clusters <- ct_vacant_dataset %>% 
  group_by(boro_ct201, vacant_on_12_31) %>% 
  summarize(count_vacant=n()) %>% 
  complete(vacant_on_12_31, fill = list(count_vacant = 0)) %>% 
  mutate(perc_vacant = count_vacant/sum(count_vacant), 
         perc_vacant = round(perc_vacant, 2), 
         total_storefronts = sum(count_vacant)) 

# ???
ct_vacant_clusters <- ct_vacant_clusters[-c(1:2),] %>% 
  filter(vacant_on_12_31=="YES")


library(cluster)

set.seed(124)
wss <- sapply(1:10, function(k){kmeans(ct_vacant_clusters[,4:5], k, nstart = 50, iter.max = 15)$tot.withinss})
plot(1:10, wss,type="b", xlab= "k values")
#abline(v=4)

km <- kmeans(ct_vacant_clusters[,c(4:5)], centers = 3)
km

#vacancy$cluster = km$cluster
ct_vacant_clusters$cluster <- km$cluster

table(ct_vacant_clusters$cluster)
table(ct_vacant_clusters$cluster_recoded)

ct_vacant_clusters <- ct_vacant_clusters %>% 
  mutate(cluster_recoded = ifelse(cluster == 1, 1, ifelse(cluster == 2, 3, 2))) 

ct_vacant_clusters.shp <- ct_vacant_clusters %>% 
  ungroup() %>% 
  as.data.frame() %>%
  left_join(ct.shp, by = c("boro_ct201")) %>% 
  st_as_sf() %>% 
  st_transform('+proj=longlat +datum=WGS84')
```

```{r include=FALSE}
ct_vacant_clusters_no_zero <- ct_vacant_clusters %>% 
  filter(perc_vacant != 0)

set.seed(125)
wss <- sapply(1:10, function(k){kmeans(ct_vacant_clusters_no_zero[,4:5], k, nstart = 50, iter.max = 15)$tot.withinss})
plot(1:10, wss,type="b", xlab= "k values")
#abline(v=4)

km <- kmeans(ct_vacant_clusters_no_zero[,c(4:5)], centers = 2)
km
```

```{r}
#vacancy$cluster = km$cluster
ct_vacant_clusters$cluster <- 0
ct_vacant_clusters_no_zero$cluster <- km$cluster
ct_vacant_clusters <- ct_vacant_clusters %>% 
  filter(perc_vacant == 0) %>% 
  bind_rows(ct_vacant_clusters_no_zero)

ct_vacant_clusters.shp <- ct_vacant_clusters %>% 
  left_join(ct.shp, by = c("boro_ct201")) %>%
  ungroup() %>% 
  st_as_sf() %>% 
  st_transform('+proj=longlat +datum=WGS84')
```


```{r, include=FALSE}
cluster_map <- leaflet::leaflet(options = leafletOptions(minZoom = 10), 
                       height = 700, width =  700) %>%
  addPolygons(data=boro, stroke = T, fill=F, color = "#666666", weight = 1) %>%
  addPolygons(weight = 1,
              fillColor = "red",
              color="black",
              stroke = TRUE,
              fillOpacity = 0.8) %>%
  addPolygons(data = ct_vacant_clusters.shp %>% filter(cluster_recoded==2) %>% st_as_sf() %>% st_transform('+proj=longlat +datum=WGS84'), weight = 1 ,
              fillColor = "pink",
              color="black",
              stroke = TRUE,
              fillOpacity = 0.8) %>%
  addPolygons(data = ct_vacant_clusters.shp %>% filter(cluster_recoded==3) %>% st_as_sf() %>% st_transform('+proj=longlat +datum=WGS84'), weight = 1 ,
              fillColor = "orange",
              color="black",
              stroke = TRUE,
              fillOpacity = 0.6) %>% addPolygons(data = ct.shp %>% mutate(boro_ct201=as.character(boro_ct201)) %>% anti_join(ct_vacant.shp %>% data.frame(), by=c("boro_ct201")), weight = 1,
              fillColor = "white",
              color="black",
              stroke = TRUE,
              fillOpacity = 1) %>% addLegend(position ="topleft", 
            colors = c("red", "orange", "pink"),
            labels = c("vacant: 14.41% storefronts: 206", "vacant: 10.38%  storefronts: 84", "vacant: 13.86% storefronts: 24"),
            title = "Cluster Means",
            opacity = 8) %>% 
  setMapWidgetStyle(list(background= "white")) %>%
    setView(-73.94000, 40.73309, 10.5) 
```

```{r}
# km <- kmeans(ct_vacant_clusters[,c(4:5)], centers = 3)
# km
```

```{r}
# saving map
saveWidget(cluster_map, file=file.path('../visuals', 
                               "cluster_map_2022.html"))
mapshot(cluster_map, file = "../visuals/cluster_map_2022.png")
```


